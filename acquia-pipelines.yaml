version: 1.0.0
variables:
  global:
    PASSWORD: test_password
    CUSTOM_VAR: value
events:
  build:
    steps:
      - behaviors:
          type: script
          script:
            - echo "Setting metadata"
            - pipelines_metadata 'hello' 'world'
            - echo "Executing default event"
            - echo "Testing env vars"
            - 'echo "CI=" : ${CI?"Need to set CI"}'
            - export PERSISTENT_VAR=persistent
            - 'echo "Testing custom ENV vars"'
            - echo $MY_VAR_3
            - echo $MY_VAR_4
            - 'echo "Testing persisting env vars across events"'
            - "echo '{ \"environment\": { \"new_var_1\":\"new_val_1\" } }' > \"${PIPELINES_SCRIPT_DATA_FILE}\""
            - 'echo "Testing NVM"'
            - nvm --version
            - nvm install v8.11.1
            - nvm use 8.11.1
            - npm install color
      - background-check:
          type: script
          script:
            - 'test -d /proc/$(cat /tmp/bg.pid) && echo "Background job is still running."'
      - variable-across-steps-check:
          type: script
          script:
            - 'echo "PERSISTENT_VAR=" : ${PERSISTENT_VAR?"Need to set PERSISTENT_VAR"}'
      - check-ssh-key-access:
          type: script
          script:
            - 'echo "CHECK IF SSH KEYS EXISTS ON BUILD EVENT"'
            - ls -l ~/.ssh
            - sleep 50
  post-deploy:
    steps:
      - check-ssh-key-access:
          type: script
          script:
            - 'echo "CHECK IF SSH KEYS EXISTS ON POST DEPLOY EVENT"'
            - ls -l ~/.ssh
      - cat:
         type: script
         script:
         - echo 'Executing post-deploy event'
         - 'echo "new_var_1=" : ${new_var_1?"Need to set new_var_1"}'
