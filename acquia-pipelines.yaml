version: 1.0.0

events:
  build:
    steps:
      - behaviors:
          type: script
          script:
            - echo "Setting metadata"
            - pipelines_metadata 'hello' 'world'
            - echo "Executing default event"
            - echo "Creating a long-running background job that should be killed"
            - echo "Testing env vars"
            - 'echo "PIPELINE_GIT_HEAD_REF=" : ${PIPELINE_GIT_HEAD_REF?"Need to set PIPELINE_GIT_HEAD_REF"}'
            - export PERSISTENT_VAR=persistent
            - 'echo "Testing custom ENV vars"'
            - 'echo "Testing persisting env vars across events"'
            - "echo '{ \"environment\": { \"new_var_1\":\"new_val_1\" } }' > \"${PIPELINES_SCRIPT_DATA_FILE}\""
      - variable-across-steps-check:
          type: script
          script:
            - 'echo "PERSISTENT_VAR=" : ${PERSISTENT_VAR?"Need to set PERSISTENT_VAR"}'
            - sleep 50
  post-deploy:
    steps:
      - verify_vars:
         type: script
         script:
         - echo 'Executing post-deploy event'
         - 'echo "new_var_1=" : ${new_var_1?"Need to set new_var_1"}'
